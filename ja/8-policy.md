# CIP-8: Policy

## 0. Abstract

本仕様は、Concrnt リソースに対するアクセス制御ポリシーを定義するための枠組みを示します。ポリシードキュメントの構造、評価の流れ、主要な演算子とアクションを述べ、プログラマブルな権限制御を可能にします。

## 1. Status of This Memo

本ドキュメントは Concrnt Policy のインターネット・ドラフトです。Concrnt プロジェクトが公開するバージョン付き仕様であり、実装者およびプロトコル設計者を対象とします。ドラフト期間中は後方互換性のない変更が行われる可能性があるため、実装者は CIP 番号とバージョンを確認し、更新に追従しなければなりません（MUST）。

## 2. 表記規則

大文字のキーワードは BCP 14 [RFC2119] [RFC8174] にしたがって解釈されます。

## 3. イントロダクション

Concrnt では、バックエンドの改修を伴わずに鍵付きアカウントや限定公開を実現するため、リソースにポリシーを付与します。ポリシーはリソースにアタッチされ、読み書きや関連付けなどの操作が行われる際に評価されます。

## 4. Policy Document の構造

ポリシーは JSON オブジェクトで表現され、`statements` と `defaults` から構成されます。`statements` は名前付きの Statement を持ち、条件式と優先度を含みます。`defaults` はアクションごとの初期許可/拒否を示します。各 Statement は `dominant`, `defaultOnTrue`, `defaultOnFalse`, `condition` を持ち、条件に基づき許可・拒否を決定します。

## 5. アクション

代表的なアクションには、レコードの読み取りや更新、削除、関連付け、コレクション配布などがあります。実装は必要に応じてアクション名を拡張できますが、意味を明確にし一貫した名前を用いるべきです（SHOULD）。

## 6. 演算子

条件式は論理演算や比較演算、コンテキスト読み出しを組み合わせて構築します。`And`、`Or`、`Not` といった論理演算のほか、`Eq`、`Contains`、`Const` を備えます。`LoadParam` や `LoadDocument` などの演算子で、ポリシーに渡されたパラメータや対象ドキュメントのフィールドを参照できます。サーバのドメインや CSID を得る `DomainFQDN`、`DomainCSID`、呼び出しユーザーの種別やタグを判定する演算子も提供されます。

## 7. 評価の流れ

評価は、対象リソースとアクションに対して適用される Statement を順に処理し、条件式を評価します。`dominant` が真の Statement が成立した場合、その結果を即座に反映するなど、優先度を実装で定義します。条件に一致しない場合は `defaults` の値に従います。実装は評価順と短絡のルールを文書化し、予期しない結果を避ける必要があります。

## 8. セキュリティとプライバシー

ポリシーはリソース保護の中心要素であるため、改ざん防止のために署名や認可されたチャネルで配布することが望まれます。評価に用いる外部リソースやパラメータが信頼できるものであることを確認してください。デフォルト許可を採用する場合は意図しない情報漏えいに注意し、デフォルト拒否を基本とする構成を推奨します。

## 9. 参考文献 (References)

[RFC2119] Bradner, S., “Key words for use in RFCs to Indicate Requirement Levels”, March 1997.  
[RFC8174] Leiba, B., “Ambiguity of Uppercase vs Lowercase in RFC 2119 Key Words”, May 2017.
